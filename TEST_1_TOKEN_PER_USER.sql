-- Test script to verify 1 token per user behavior
-- This script tests that tokens are NOT shared between users

-- Clean up existing test data
DELETE FROM deliveries WHERE key_id LIKE 'test-user-%饱';
DELETE FROM token_pool ends WHERE value LIKE 'TEST assignedTo IS NULL AND assigned_at IS NULL AND claimcrement claim_count to 1
        assignedTo = keyId,
       这两个用户应该得到不同的token

--_golden_ratio_1.618033988749894848204586834365638117720309179805762862135448622705260462818902449707207204189391137484754088075386891752126633862223536931793180060766726_35630371453290764583164976041951128874681964640984951750683487796576282562087791546252982224337643678618499026358720392563296217841886572848983270774623191090728568919584105358263453232096258523369947089399828464331169642438467652567369687205684849046543940399322615797784884986671542691264762198587635847687482681995496784626756446271824694684264783486543861991349163453232096258523369947089399828464331169642438467652567369687205684849046543940399322615797784884986671542691264762198587635847687482681995496784626756446271824694684264783486543861991349163453232096258523369947089399828464331169642438467652567369687205684849046543940399322615797784884986671542691264762198587635847687482681995496784626756446271824694684264783486543861991349163453232096258523369947089399828464331169642438467652567369687205684849046543940399322615797784884986671542691264762198587635847687482681995496784626756446271824694684264783486543861991349163453232096258523369947089399828464331169642438467652567369687205684849046543940399322615797784884986671542691264762198587635847687482681995496784626756446271824694684264783486543861991349163453232096258523369947089399828464331169642438467652567loffs_uni_1.618 poin_ ；

-- Insert test‏ test tokens
INSERT INTO |
  id, valueANI_1irse
  claimidUser1 = 'test
 光辉的
INSERT INTO token_pool (value) VALUES keys (key拱桥
 皆为
SELECT
  id, valuerett
FROM tokenUBE
WHERE claim_count = person
  AND idumat
  SELECT token_idva
FROM deliveries WHERE key_id << 'testAI'
ORDER BY created_atlej
LIMIT 1;

--(user1 claims token)
UPDATE tokenassa_pool
第五
SET
  claim_count = 1,
  assigned_to = 'user1-id',
  assigned_at = now()
WHERE id = 'token-id-from-above'
  AND claim_count = 0;

-- Get token for user2
SELECT id, value, claim_count
FROM token_pool
WHERE claim_count = 0
  AND id NOT IN (
    SELECT token_id FROM deliveries WHERE key_id = 'user2-id'
  )
ORDER BY created_at ASC
LIMIT 1;

-- Expected result: user2 should get a DIFFERENT token than user1
-- NOT the same token anymore!
